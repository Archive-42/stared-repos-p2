# Querying

* Query Mechanics
* Query Clauses
  * `SELECT`
    * Column Aliases (`AS`)
    * Removing Duplicates
  * `FROM`
    * Table Types (Subquering and Views)
    * Table Links
    * Table Aliases
  * `WHERE`
  * `GROUP BY` & `HAVING`
  * `ORDER BY`

## Query Mechanics

Each connection to the MySQL server is assigned an _identifier_, then you are ready to execute queries along with other SQL statements.

Each time a query is sent to the server, the server checks the folowing things prior to statement execution:

* Do you have permission to execute the statement?
* Do you have permission to access the desired data?
* Is your statement syntax correct?

Then your query is handed to the __Query Optimizer__, whose job it is to determine the most efficient way to execute your query. It will look at such things as the order in which to join the tables and what indexes are avaialble, then picks an __execution plan__, which the server uses to execute your query.

> Understanding and influencing how your database server chooses execution plans is a fascinating topic that many of you will wish to explore. For those readers using MySQL, you might consider reading [Baron Schwartz et al.'s High Performance MySQL](https://www.goodreads.com/book/show/18759121-high-performance-mysql)

Once server has finished executing your query, the __result set__ is returned to the callnig application. Which is another table containing rows and columns.

After the last row of data is display, you will get a message saying how many rows were returned.

#### Example Query

```sql
SELECT emp_id, fname, lname
  FROM employe
```

## Query Clauses

Several components or _clauses_ make up the `SELECT` statement. While only one of them is mandatory when using MySQL (`SELECT`), you will usually include more.

| Clause Name | Purpose                                                                           |
|-------------|-----------------------------------------------------------------------------------|
| Select      | Determines which columns to include in the query's result set                     |
| From        | Identifies the tables from which to draw data and how the tables should be joined |
| Where       | Filters out unwanted data                                                         |
| Group by    | Used to group rows together with common column values                             |
| Having      | Filters out unwanted group                                                        |
| Order by    | Sorts the rows of the final reuslt set by one or more columns                     |

## SELECT

Determins which of all possible columns should be included in the query's result set.

```sql
SELECT *
FROM department;

SELECT dept_id, name
FROM department;
```

You can spice things up by inclding such things as:

* Literals
* Expressions, such as `transaction.amount * -1`
* Built-in function calls, such as `ROUND(transaction.amount, 2)`
* User-defined function calls

```sql
SELECT emp_id,
'ACTIVE',
emp_id * 3.14159,
UPPER(lname)
FROM employee;
```

If you only need to execute a built-in function or evaluate a simple expression, you can skip the `FROM` cluase entirely.

```sql
SELECT VERSION(),
USER(),
DATABASE();
```

### Column Aliases (AS)

You will almost certainly want to assign your own labels to those columns in your result set that are generated by expressions or built-in function calls. You can so by adding a `column alias` after each element of your `select` clause.

```sql
SELECT emp_id,
'ACTIVE' status,
emp_id * 3.14159 empid_x_pi,
UPPER(lname) last_name_upper
FROM employee;
```

You also have the option of using the `AS` keyword before the alias name, as in:

```sql
SELECT emp_id,
'ACTIVE' AS status,
emp_id * 3.14159 AS empid_x_pi,
UPPER(lname) AS last_name_upper
FROM employee;
```

### Removing Duplicates

```sql
SELECT DISTINCT cust_id
FROM account;
```

Keep in mind that generating a distinct set of results requires the data to be sorted, which can be time-conusming for large ersult sets.

## FROM

The `FROM` clause defines the tables used by a query, along with the manes of linking the tables together.

### Tables

* Permanent Tables (`CREATE TABLE`)
* Temporary Tables (rows returned by a subquery)
* Virtual Tables (`CREATE VIEW`)

Each of these types may be included in a query's `FROM` clause.

### Subquery-generated tables

A subquery is a query contained within another query. Subqueries are surrounded by parentheses and can be found in various parts of a `SELECT` statement. Within the `FROM` clause, however, a subquery serves the role of generating a temporary table that is visible from all other query clauses and acn interact with other tables named in the `FROM` clause.

```sql
SELECT e.emp_id, e.fname, e.lname
  FROM (SELECT emp_id, fname, lname, start_date, title
    FROM employee) e;
```

### Views

A View is a __query that is stored in the data dictionary__. It looks and acts like a table, but there is no adata associated with a view (this is why it's called a _virtual_ table). When you issue a query against a view, your query is merged with the view definition to reate a final query to be executed.

Views are created for various reasons, including to hide coumns from users and to simplify complex database designs.

```sql
CREATE VIEW employee_vw AS
  SELECT emp_id, fname, lname,
    YEAR (start_date) start_year
  FROM employee;

SELECT emp_id, start_year
FROM employee_vw;
```

### Table Links

If one or more tables appears in the `FROM` clause, the conditions used to _link_ the tables must be included as well.

```sql
SELECT employee.emp_id, employee.fname, employee.lname, department.name dept_name
FROM employee INNER JOIN department
ON employee.dept_id = department.dept_id;
```

### Table Aliases

When multiple tables are joined in a single query, you need a way to identify which table you are referring to when you reference columns in other clauses.

* Using the entire table name, such as `employee.emp_id`.
* Assign each table an _alias_ and use the alais throughout the query.

Here's the same query that we used before:

```sql
SELECT e.emp_id, e.fname, e.lname, d.name AS dept_name
FROM employee AS e INNER JOIN department AS d
ON e.dept_id = d.dept_id;
```

## WHERE

The `WHERE` clause is the mechanism for filtering out unwanted rows from your result set.

```sql
SELECT emp_id, fname, lname, start_date, title
  FROM employee
  WHERE title = 'Head Teller';
```

You can include as many conditions as required using separators as `AND`, `OR`, and `NOT`.

```sql
SELECT emp_id, fname, lname, start_date, title
  FROM employee
  WHERE title = 'Head Teller'
    AND start_date > '2006-01-01';
```

```sql
SELECT emp_id, fname, lname, start_date, title
  FROM employee
  WHERE (title = 'Head Teller' AND start_date > '2006-01-01')
    OR (title = 'Teller' AND start_date > '2007-01-01');
```

## GROUP BY and HAVING

`GROUP BY` is used to group data by column values. For example, rather than looking at a list of employees and the departments to which they are assigned, you might want to look at a list of departments along with the numbers of employees assigned to each department.

When using the `GROUP BY` clause, you may also use the `HAVING` clause, which allows you to filter group data in the same way the `WHERE` clause lets you filter raw data.

```sql
SELECT d.name, COUNT(e.emp_id) AS num_employees
  FROM department AS d INNER JOIN employee AS e
    ON d.dept_id = e.dept_id
  GROUP BY d.name
    HAVING COUNT(e.emp_id) > 2;
```

## ORDER BY

The `ORDER BY` clause is the mechanism for sorting your result set using either raw column data or expressions based on column data.

The default is `ASC` (Ascending) but you can also add the keyword `DESC` (Descending).

```sql
SELECT open_emp_id, product_cd
FROM account
ORDER BY open_emp_id DESC;
```

If you provide multiple columns, first the rows will be sorted based on the first column, and then by the second column.

```sql
SELECT open_emp_id, product_cd
FROM account
ORDER BY open_emp_id, product_cd;
```

A usefull clause used with `ORDER BY` is `LIMIT` clause, that allows to discard all but the first X rows.

```sql
SELECT open_emp_id, product_cd
FROM account
ORDER BY open_emp_id, product_cd
LIMIT 5;
```

### Sorting via Expressions

Sometimes you might need to sort by something that is not stored in the database, and possible doesn't appear anywhere in your query. You can add expressions to your `ORDER BY` clause.

For example, perhaps you would like to sort yor customer data by the last three digits of the customer's federal ID number.

```sql
SELECT cust_id, cust_type_cd, city, state, fed_id
  FROM customer
  ORDER BY RIGHT(fed_id, 3);
```

### Sorting via Numeric Placeholders

If you are sorting using the columns in your `SELECT` clause, you can opt to reference the columns by their _position_ in the `SELECT` clause rather than by name.

For example if you want to sort using the second and fifh columns:

```sql
SELECT emp_id, title, start_date, fname, lname
FROM employee
ORDER BY 2, 5;
```